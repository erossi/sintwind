/* This file is part of OpenSint
 * Copyright (C) 2005-2007 Enrico Rossi
 * 
 * OpenSint is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * OpenSint is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include <inttypes.h>
#include <avr/io.h>
#include <avr/pgmspace.h>
#include "default.h"
#include "bus.h"
#include "ace128.h"

static const prog_uint8_t lut[] = {
  255,				/* 00 */
  56, 40, 55, 24,		/* 01 - 04 */
  255, 39, 52, 8,		/* 05 - 08 */
  57, 255, 255, 23,		/* 09 - 12 */
  255, 36, 13, 120,		/* 13 - 16 */
  255, 41, 54, 255,		/* 17 - 20 */
  255, 255, 53, 7,		/* 21 - 24 */
  255, 255, 255, 20,		/* 25 - 28 */
  19, 125, 18, 104,		/* 29 - 32 */
  105, 255, 255, 25,		/* 33 - 36 */
  106, 38, 255, 255,		/* 37 - 40 */
  58, 255, 255, 255,		/* 41 - 44 */
  255, 37, 14, 119,		/* 45 - 48 */
  118, 255, 255, 255,		/* 49 - 52 */
  107, 255, 255, 4,		/* 53 - 56 */
  255, 3, 255, 109,		/* 57 - 60 */
  108, 2, 1, 88,		/* 61 - 64 */
  255, 89, 255, 255,		/* 65 - 68 */
  255, 255, 51, 9,		/* 69 - 72 */
  10, 90, 255, 22,		/* 73 - 76 */
  11, 255, 12, 255,		/* 77 - 80 */
  255, 42, 43, 255,		/* 81 - 84 */
  255, 255, 255, 255,		/* 85 - 88 */
  255, 255, 255, 21,		/* 89 - 92 */
  255, 126, 127, 103,		/* 93 - 96 */
  255, 102, 255, 255,		/* 97 - 100 */
  255, 255, 255, 255,		/*101 - 104 */
  255, 91, 255, 255,		/*105 - 108 */
  255, 255, 255, 116,		/*109 - 112 */
  117, 255, 255, 115,		/*113 - 116 */
  255, 255, 255, 93,		/*117 - 120 */
  94, 92, 255, 114,		/*121 - 124 */
  95, 113, 0, 72,		/*125 - 128 */
  71, 255, 68, 73,		/*129 - 132 */
  255, 255, 29, 255,		/*133 - 136 */
  70, 255, 69, 255,		/*137 - 140 */
  255, 35, 34, 121,		/*141 - 144 */
  255, 122, 255, 74,		/*145 - 148 */
  255, 255, 30, 6,		/*149 - 152 */
  255, 123, 255, 255,		/*153 - 156 */
  255, 124, 17, 255,		/*157 - 160 */
  255, 255, 67, 26,		/*161 - 164 */
  255, 27, 28, 255,		/*165 - 168 */
  59, 255, 255, 255,		/*169 - 172 */
  255, 255, 15, 255,		/*173 - 176 */
  255, 255, 255, 255,		/*177 - 180 */
  255, 255, 255, 5,		/*181 - 184 */
  255, 255, 255, 110,		/*185 - 188 */
  255, 111, 16, 87,		/*189 - 192 */
  84, 255, 45, 86,		/*193 - 196 */
  85, 255, 50, 255,		/*197 - 200 */
  255, 255, 46, 255,		/*201 - 204 */
  255, 255, 33, 255,		/*205 - 208 */
  83, 255, 44, 75,		/*209 - 212 */
  255, 255, 31, 255,		/*213 - 216 */
  255, 255, 255, 255,		/*217 - 220 */
  255, 255, 32, 100,		/*221 - 224 */
  61, 101, 66, 255,		/*225 - 228 */
  62, 255, 49, 99,		/*229 - 232 */
  60, 255, 47, 255,		/*233 - 236 */
  255, 255, 48, 77,		/*237 - 240 */
  82, 78, 65, 76,		/*241 - 244 */
  63, 255, 64, 98,		/*245 - 248 */
  81, 79, 80, 97,		/*249 - 252 */
  96, 112, 255			/*253 - 255 */
};

/* 
   {
   255,             // 00
   056,040,055,024, // 01 - 04
   255,039,052,008, // 05 - 08
   057,255,255,023, // 09 - 12
   255,036,013,120, // 13 - 16
   255,041,054,255, // 17 - 20
   255,255,053,007, // 21 - 24
   255,255,255,020, // 25 - 28
   019,125,018,104, // 29 - 32
   105,255,255,025, // 33 - 36
   106,038,255,255, // 37 - 40
   058,255,255,255, // 41 - 44
   255,037,014,119, // 45 - 48
   118,255,255,255, // 49 - 52
   107,255,255,004, // 53 - 56
   255,003,255,109, // 57 - 60
   108,002,001,088, // 61 - 64
   255,089,255,255, // 65 - 68
   255,255,051,009, // 69 - 72
   010,090,255,022, // 73 - 76
   011,255,012,255, // 77 - 80
   255,042,043,255, // 81 - 84
   255,255,255,255, // 85 - 88
   255,255,255,021, // 89 - 92
   255,126,127,103, // 93 - 96
   255,102,255,255, // 97 - 100
   255,255,255,255, //101 - 104
   255,091,255,255, //105 - 108
   255,255,255,116, //109 - 112
   117,255,255,115, //113 - 116
   255,255,255,093, //117 - 120
   094,092,255,114, //121 - 124
   095,113,000,072, //125 - 128
   071,255,068,073, //129 - 132
   255,255,029,255, //133 - 136
   070,255,069,255, //137 - 140
   255,035,034,121, //141 - 144
   255,122,255,074, //145 - 148
   255,255,030,006, //149 - 152
   255,123,255,255, //153 - 156
   255,124,017,255, //157 - 160
   255,255,067,026, //161 - 164
   255,027,028,255, //165 - 168
   059,255,255,255, //169 - 172
   255,255,015,255, //173 - 176
   255,255,255,255, //177 - 180
   255,255,255,005, //181 - 184
   255,255,255,110, //185 - 188
   255,111,016,087, //189 - 192
   084,255,045,086, //193 - 196
   085,255,050,255, //197 - 200
   255,255,046,255, //201 - 204
   255,255,033,255, //205 - 208
   083,255,044,075, //209 - 212
   255,255,031,255, //213 - 216
   255,255,255,255, //217 - 220
   255,255,032,100, //221 - 224
   061,101,066,255, //225 - 228
   062,255,049,099, //229 - 232
   060,255,047,255, //233 - 236
   255,255,048,077, //237 - 240
   082,078,065,076, //241 - 244
   063,255,064,098, //245 - 248
   081,079,080,097, //249 - 252
   096,112,255      //253 - 255
   };
*/

/* return 0-359 degrees */
int
get_wind_position (void)
{
  volatile uint8_t v;
  int i;

  /* switch the bus to read wind speed */
  switch_bus (WIND_DIR, 0);

  v = DATABUS_PIN;		/* read encoder */

  /* find out which is direction */
  i = pgm_read_byte (&(lut[v]));

  /* Adjust ratio to get 0-127 to 0-359 degrees */
  i = i * ACE128_RATIO;

  /* switch back the databus to where it was */
  switch_bus (NULL_BUS, 0);

  return (i);
}

/*
  return standard direction
  from encoder 0-359
*/
enum wind_dir
get_wind_direction (int direction)
{
  enum wind_dir wind;

  wind = NORTH;

  if ((direction < 23) || (direction >= 338))
    wind = NORTH;
  if ((direction >= 23) && (direction < 68))
    wind = NORTH_EAST;
  if ((direction >= 68) && (direction < 113))
    wind = EAST;
  if ((direction >= 113) && (direction < 158))
    wind = SOUTH_EAST;
  if ((direction >= 158) && (direction < 203))
    wind = SOUTH;
  if ((direction >= 203) && (direction < 248))
    wind = SOUTH_WEST;
  if ((direction >= 248) && (direction < 293))
    wind = WEST;
  if ((direction >= 293) && (direction < 338))
    wind = NORTH_WEST;

  return (wind);
}
